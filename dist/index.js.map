{"version":3,"file":"index.js","names":["options?: {\r\n      timeout?: number;\r\n      interval?: number;\r\n    }","seen: any[]","out","resolveInitialValue: ((value: T) => void) | undefined","init: (\r\n      provider: Provider<T>,\r\n      args: ContextArgs<C>\r\n    ) => Promise<void> | void","get!: () => Promise<T>","close!: () => void","provider: Provider<T>","cleanup: (() => void)[]"],"sources":["../src/planner.ts","../src/lib/stringify.ts","../src/lib/stream.ts","../src/resource.ts"],"sourcesContent":["export type PlannerCB = (\r\n  call: () => void,\r\n  cleanup: (fn: () => void) => void\r\n) => void;\r\n\r\nexport class Planner {\r\n  private calls = new Set<() => void>();\r\n  private cleanups = new Set<() => void>();\r\n\r\n  constructor(\r\n    private readonly options?: {\r\n      timeout?: number;\r\n      interval?: number;\r\n    }\r\n  ) {}\r\n\r\n  get into(): PlannerCB {\r\n    return (call, cleanup) => {\r\n      this.calls.add(call);\r\n\r\n      if (this.calls.size === 1) {\r\n        this.start();\r\n      }\r\n\r\n      const remove = () => {\r\n        this.calls.delete(call);\r\n        if (this.calls.size === 0) {\r\n          this.cleanup();\r\n        }\r\n      };\r\n      cleanup(remove);\r\n    };\r\n  }\r\n\r\n  private start() {\r\n    if (this.options?.timeout) {\r\n      const timeout = setTimeout(() => this.call(), this.options.timeout);\r\n      this.cleanups.add(() => clearTimeout(timeout));\r\n    }\r\n    if (this.options?.interval) {\r\n      const timeout = setInterval(() => this.call(), this.options.interval);\r\n      this.cleanups.add(() => clearInterval(timeout));\r\n    }\r\n  }\r\n\r\n  private cleanup() {\r\n    this.cleanups.forEach((fn) => {\r\n      try {\r\n        fn();\r\n      } catch {}\r\n    });\r\n    this.cleanups.clear();\r\n  }\r\n\r\n  call() {\r\n    this.calls.forEach((fn) => {\r\n      try {\r\n        fn();\r\n      } catch {}\r\n    });\r\n  }\r\n}\r\n","export function stableStringify(data: any): string {\r\n  const seen: any[] = [];\r\n\r\n  function stringifyInternal(node: any): string | undefined {\r\n    if (node && typeof node.toJSON === \"function\") {\r\n      node = node.toJSON();\r\n    }\r\n\r\n    if (typeof node === \"bigint\") {\r\n      return `\"${node.toString()}n\"`;\r\n    }\r\n\r\n    if (node === undefined || typeof node === \"function\") {\r\n      return undefined;\r\n    }\r\n\r\n    if (typeof node !== \"object\" || node === null) {\r\n      if (typeof node === \"number\" && !Number.isFinite(node)) {\r\n        return \"null\";\r\n      }\r\n      return JSON.stringify(node);\r\n    }\r\n\r\n    if (Array.isArray(node)) {\r\n      let out = \"[\";\r\n      for (let i = 0; i < node.length; i++) {\r\n        if (i > 0) out += \",\";\r\n        const value = stringifyInternal(node[i]);\r\n        out += value === undefined ? \"null\" : value;\r\n      }\r\n      return out + \"]\";\r\n    }\r\n\r\n    if (seen.includes(node)) {\r\n      return JSON.stringify(\"__cycle__\");\r\n    }\r\n\r\n    if (node instanceof Date) {\r\n      return `\"${node.toISOString()}\"`;\r\n    }\r\n\r\n    if (node instanceof RegExp) {\r\n      return JSON.stringify(node.toString());\r\n    }\r\n\r\n    if (node instanceof Map) {\r\n      const sortedEntries = Array.from(node.entries()).sort((a, b) =>\r\n        String(a[0]).localeCompare(String(b[0]))\r\n      );\r\n      let out = \"[\";\r\n      for (let i = 0; i < sortedEntries.length; i++) {\r\n        if (i > 0) out += \",\";\r\n        const [map_key, map_value] = sortedEntries[i];\r\n        out +=\r\n          `[${stringifyInternal(map_key)},` +\r\n          `${stringifyInternal(map_value)}]`;\r\n      }\r\n      return out + \"]\";\r\n    }\r\n\r\n    if (node instanceof Set) {\r\n      const sortedValues = Array.from(node.values()).sort((a, b) => {\r\n        return String(a).localeCompare(String(b));\r\n      });\r\n      let out = \"[\";\r\n      for (let i = 0; i < sortedValues.length; i++) {\r\n        if (i > 0) out += \",\";\r\n        out += stringifyInternal(sortedValues[i]);\r\n      }\r\n      return out + \"]\";\r\n    }\r\n\r\n    const seenIndex = seen.push(node) - 1;\r\n\r\n    const keys = Object.keys(node).sort();\r\n    let out = \"\";\r\n    let first = true;\r\n    for (const key of keys) {\r\n      const value = stringifyInternal(node[key]);\r\n\r\n      if (value === undefined) continue;\r\n\r\n      if (!first) out += \",\";\r\n      first = false;\r\n      out += JSON.stringify(key) + \":\" + value;\r\n    }\r\n\r\n    seen.splice(seenIndex, 1);\r\n    return \"{\" + out + \"}\";\r\n  }\r\n  return stringifyInternal(data) || \"null\";\r\n}\r\n","export function promiseStream<T>(asyncGenerator: AsyncGenerator<T, any, any>) {\r\n  let resolveInitialValue: ((value: T) => void) | undefined;\r\n  const initialValuePromise: Promise<T> = new Promise((resolve) => {\r\n    resolveInitialValue = resolve;\r\n  });\r\n\r\n  let value = initialValuePromise;\r\n\r\n  function call() {\r\n    (async () => {\r\n      const result = await asyncGenerator.next();\r\n\r\n      if (result.done) return;\r\n\r\n      if (resolveInitialValue) {\r\n        resolveInitialValue(result.value);\r\n        resolveInitialValue = undefined;\r\n      } else {\r\n        value = Promise.resolve(result.value);\r\n      }\r\n    })();\r\n  }\r\n\r\n  function getValue() {\r\n    return value;\r\n  }\r\n\r\n  return { call, getValue };\r\n}\r\n","import { stableStringify } from \"./lib/stringify\";\r\nimport { promiseStream } from \"./lib/stream\";\r\nimport { PlannerCB } from \"./planner\";\r\n\r\ntype ContextArgs<C> = keyof C extends never ? void : C;\r\ntype Provider<T> = (args: {\r\n  handler: () => Promise<T> | T;\r\n  planner: PlannerCB;\r\n}) => Promise<void>;\r\n\r\ntype Instance<T> = {\r\n  refCount: number;\r\n  running: boolean;\r\n  close: () => void;\r\n  get: () => Promise<T>;\r\n};\r\n\r\nexport class Resource<T, C = {}> {\r\n  private instances = new Map<string, Instance<T>>();\r\n\r\n  constructor(\r\n    private init: (\r\n      provider: Provider<T>,\r\n      args: ContextArgs<C>\r\n    ) => Promise<void> | void\r\n  ) {}\r\n\r\n  use(ctx: ContextArgs<C>) {\r\n    const key = stableStringify(ctx);\r\n    const instance = this.instances.get(key) ?? this.createInstance(key, ctx);\r\n\r\n    instance.refCount++;\r\n\r\n    return this.createHandle(instance);\r\n  }\r\n\r\n  private createInstance(key: string, ctx: ContextArgs<C>): Instance<T> {\r\n    let get!: () => Promise<T>;\r\n    let close!: () => void;\r\n    let running = true;\r\n\r\n    const provider: Provider<T> = ({ handler, planner }) => {\r\n      const { call, getValue } = this.createStream(handler, () => running);\r\n\r\n      const cleanup: (() => void)[] = [];\r\n\r\n      get = getValue;\r\n      planner(call, (fn) => cleanup.push(fn));\r\n\r\n      return new Promise<void>((resolve) => {\r\n        close = () => {\r\n          cleanup.forEach((fn) => fn());\r\n          this.instances.delete(key);\r\n          if (running) resolve();\r\n          running = false;\r\n        };\r\n      });\r\n    };\r\n\r\n    this.init(provider, ctx);\r\n\r\n    const instance = {\r\n      refCount: 0,\r\n      running,\r\n      close,\r\n      get,\r\n    };\r\n\r\n    this.instances.set(key, instance);\r\n    return instance;\r\n  }\r\n\r\n  private createStream(\r\n    handler: () => Promise<T> | T,\r\n    isRunning: () => boolean\r\n  ) {\r\n    return promiseStream(\r\n      (async function* () {\r\n        while (isRunning()) {\r\n          const t = await handler();\r\n          if (!isRunning()) return;\r\n          yield t;\r\n        }\r\n      })()\r\n    );\r\n  }\r\n\r\n  private createHandle(instance: Instance<T>) {\r\n    return {\r\n      get value() {\r\n        return instance.get();\r\n      },\r\n      async [Symbol.asyncDispose]() {\r\n        instance.refCount--;\r\n        if (instance.refCount === 0) {\r\n          instance.close();\r\n        }\r\n      },\r\n    };\r\n  }\r\n}\r\n"],"mappings":"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"}