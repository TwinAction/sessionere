{"version":3,"file":"index.js","names":["seen: any[]","out","latest: T | undefined","waiting: Array<(value: T) => void>","next: T","emptyInstance: Instance<any>","init: (\r\n      arg: {\r\n        emit: Waitable<T>[\"emit\"];\r\n        retain: Instance<T>[\"retain\"];\r\n      },\r\n      ctx: ContextArgs<C>\r\n    ) => Promise<void> | void","config?: ResourceConfig<T>","close!: () => void","until!: () => void","instance: Instance<T>"],"sources":["../src/lib/stringify.ts","../src/lib/waitable.ts","../src/resource.ts"],"sourcesContent":["export function stableStringify(data: any): string {\r\n  const seen: any[] = [];\r\n\r\n  function stringifyInternal(node: any): string | undefined {\r\n    if (node && typeof node.toJSON === \"function\") {\r\n      node = node.toJSON();\r\n    }\r\n\r\n    if (typeof node === \"bigint\") {\r\n      return `\"${node.toString()}n\"`;\r\n    }\r\n\r\n    if (node === undefined || typeof node === \"function\") {\r\n      return undefined;\r\n    }\r\n\r\n    if (typeof node !== \"object\" || node === null) {\r\n      if (typeof node === \"number\" && !Number.isFinite(node)) {\r\n        return \"null\";\r\n      }\r\n      return JSON.stringify(node);\r\n    }\r\n\r\n    if (Array.isArray(node)) {\r\n      let out = \"[\";\r\n      for (let i = 0; i < node.length; i++) {\r\n        if (i > 0) out += \",\";\r\n        const value = stringifyInternal(node[i]);\r\n        out += value === undefined ? \"null\" : value;\r\n      }\r\n      return out + \"]\";\r\n    }\r\n\r\n    if (seen.includes(node)) {\r\n      return JSON.stringify(\"__cycle__\");\r\n    }\r\n\r\n    if (node instanceof Date) {\r\n      return `\"${node.toISOString()}\"`;\r\n    }\r\n\r\n    if (node instanceof RegExp) {\r\n      return JSON.stringify(node.toString());\r\n    }\r\n\r\n    if (node instanceof Map) {\r\n      const sortedEntries = Array.from(node.entries()).sort((a, b) =>\r\n        String(a[0]).localeCompare(String(b[0]))\r\n      );\r\n      let out = \"[\";\r\n      for (let i = 0; i < sortedEntries.length; i++) {\r\n        if (i > 0) out += \",\";\r\n        const [map_key, map_value] = sortedEntries[i];\r\n        out +=\r\n          `[${stringifyInternal(map_key)},` +\r\n          `${stringifyInternal(map_value)}]`;\r\n      }\r\n      return out + \"]\";\r\n    }\r\n\r\n    if (node instanceof Set) {\r\n      const sortedValues = Array.from(node.values()).sort((a, b) => {\r\n        return String(a).localeCompare(String(b));\r\n      });\r\n      let out = \"[\";\r\n      for (let i = 0; i < sortedValues.length; i++) {\r\n        if (i > 0) out += \",\";\r\n        out += stringifyInternal(sortedValues[i]);\r\n      }\r\n      return out + \"]\";\r\n    }\r\n\r\n    const seenIndex = seen.push(node) - 1;\r\n\r\n    const keys = Object.keys(node).sort();\r\n    let out = \"\";\r\n    let first = true;\r\n    for (const key of keys) {\r\n      const value = stringifyInternal(node[key]);\r\n\r\n      if (value === undefined) continue;\r\n\r\n      if (!first) out += \",\";\r\n      first = false;\r\n      out += JSON.stringify(key) + \":\" + value;\r\n    }\r\n\r\n    seen.splice(seenIndex, 1);\r\n    return \"{\" + out + \"}\";\r\n  }\r\n  return stringifyInternal(data) || \"null\";\r\n}\r\n","export type Waitable<T> = {\r\n  emit: (value: T | Promise<T> | ((prev?: T) => T | Promise<T>)) => void;\r\n  get: () => Promise<T>;\r\n};\r\n\r\ntype WaitableOptions<T> = {\r\n  shouldAccept?: (next: T, prev?: T) => boolean;\r\n  afterEmit?: (next: T, prev?: T) => void;\r\n  equality?: (a: T, b: T) => boolean;\r\n};\r\n\r\nexport function createWaitable<T>(\r\n  options: WaitableOptions<T> = {}\r\n): Waitable<T> {\r\n  let latest: T | undefined;\r\n  let initialized = false;\r\n  let waiting: Array<(value: T) => void> = [];\r\n\r\n  async function emit(input: T | Promise<T> | ((prev?: T) => T | Promise<T>)) {\r\n    const prev = latest;\r\n\r\n    let next: T;\r\n    try {\r\n      if (typeof input === \"function\") {\r\n        const fn = input as (prev?: T) => T | Promise<T>;\r\n        next = await fn(prev);\r\n      } else {\r\n        next = await input;\r\n      }\r\n    } catch {\r\n      return;\r\n    }\r\n\r\n    const equals = options.equality ?? (() => false);\r\n\r\n    if (initialized && equals(next, prev!)) return;\r\n\r\n    if (options.shouldAccept && !options.shouldAccept(next, prev)) {\r\n      return;\r\n    }\r\n\r\n    latest = next;\r\n    initialized = true;\r\n\r\n    const queued = waiting;\r\n    waiting = [];\r\n    for (const resolve of queued) resolve(next);\r\n\r\n    if (options.afterEmit) {\r\n      queueMicrotask(() => options.afterEmit!(next, prev));\r\n    }\r\n  }\r\n\r\n  function get(): Promise<T> {\r\n    if (initialized) {\r\n      return Promise.resolve(latest as T);\r\n    }\r\n    return new Promise<T>((resolve) => {\r\n      waiting.push(resolve);\r\n    });\r\n  }\r\n\r\n  return { emit, get };\r\n}\r\n","import { stableStringify } from \"./lib/stringify\";\r\nimport { createWaitable, Waitable } from \"./lib/waitable\";\r\n\r\ntype ContextArgs<C> = keyof C extends never ? void : C;\r\n\r\ntype Subscriber<T> = (value: T) => void;\r\n\r\ntype ResourceConfig<T> = {\r\n  equality?: (a: T, b: T) => boolean;\r\n};\r\n\r\ntype Instance<T> = {\r\n  refs: Map<symbol, { notify: Subscriber<T> }>;\r\n  running: boolean;\r\n  close: () => void;\r\n  get: () => Promise<T>;\r\n  untilRetain: Promise<void>;\r\n  retain: () => Promise<void>;\r\n};\r\n\r\nconst emptyInstance: Instance<any> = {\r\n  refs: new Map(),\r\n  running: false,\r\n  close: () => {},\r\n  get: async () => {\r\n    throw new Error(\"Called get on empty Resource ref\");\r\n  },\r\n  untilRetain: Promise.resolve(),\r\n  retain: async () => {},\r\n};\r\n\r\nexport class Resource<T, C = {}> {\r\n  private instances = new Map<string, Instance<T>>();\r\n\r\n  constructor(\r\n    private init: (\r\n      arg: {\r\n        emit: Waitable<T>[\"emit\"];\r\n        retain: Instance<T>[\"retain\"];\r\n      },\r\n      ctx: ContextArgs<C>\r\n    ) => Promise<void> | void,\r\n    private config?: ResourceConfig<T>\r\n  ) {}\r\n\r\n  use(ctx: ContextArgs<C>) {\r\n    const key = stableStringify(ctx);\r\n    const instance = this.prepareInstance(key, ctx);\r\n    return this.createRef({ instance });\r\n  }\r\n\r\n  empty() {\r\n    return this.createRef({ instance: emptyInstance });\r\n  }\r\n\r\n  private prepareInstance(key: string, ctx: ContextArgs<C>): Instance<T> {\r\n    if (this.instances.get(key)) return this.instances.get(key)!;\r\n\r\n    let running = true;\r\n    let close!: () => void;\r\n    let until!: () => void;\r\n\r\n    const untilRetain = new Promise<void>((resolve) => (until = resolve));\r\n    const retain = () => {\r\n      until();\r\n      return new Promise<void>((resolve) => {\r\n        close = () => {\r\n          this.instances.delete(key);\r\n          if (running) resolve();\r\n          running = false;\r\n        };\r\n      });\r\n    };\r\n\r\n    const refs = new Map<symbol, { notify: Subscriber<T> }>();\r\n\r\n    const { emit, get } = createWaitable<T>({\r\n      equality: this.config?.equality,\r\n      shouldAccept: () => running,\r\n      afterEmit: (next) => refs.forEach((ref) => ref.notify(next)),\r\n    });\r\n\r\n    Promise.resolve(this.init({ emit, retain }, ctx)).then(until);\r\n\r\n    const instance: Instance<T> = {\r\n      refs,\r\n      running,\r\n      close,\r\n      get,\r\n      untilRetain,\r\n      retain,\r\n    };\r\n\r\n    this.instances.set(key, instance);\r\n    return instance;\r\n  }\r\n\r\n  private createRef(args: { instance: Instance<T> }) {\r\n    let instance = args.instance;\r\n    const ref = Symbol();\r\n\r\n    const subs = new Set<Subscriber<T>>();\r\n\r\n    const refEntry = {\r\n      notify: (v: T) => {\r\n        subs.forEach((fn) => fn(v));\r\n      },\r\n    };\r\n\r\n    instance.refs.set(ref, refEntry);\r\n\r\n    const changeInstance = async (ctx: ContextArgs<C>) => {\r\n      const key = stableStringify(ctx);\r\n      const newInstance = this.prepareInstance(key, ctx);\r\n      await newInstance.untilRetain;\r\n      instance.refs.delete(ref);\r\n      newInstance.refs.set(ref, refEntry);\r\n      instance = newInstance;\r\n    };\r\n\r\n    return {\r\n      get value() {\r\n        return instance.get();\r\n      },\r\n\r\n      subscribe(fn: Subscriber<T>) {\r\n        subs.add(fn);\r\n        return () => subs.delete(fn);\r\n      },\r\n\r\n      reuse(ctx: ContextArgs<C>) {\r\n        changeInstance(ctx);\r\n      },\r\n\r\n      [Symbol.dispose]() {\r\n        instance.refs.delete(ref);\r\n        if (instance.refs.size === 0) {\r\n          instance.close();\r\n        }\r\n      },\r\n    };\r\n  }\r\n}\r\n"],"mappings":"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"}